---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# gpkg

<!-- badges: start -->
<!-- badges: end -->
# gpkg - Utilities for OGC GeoPackages

{gpkg} provides high-level wrapper functions to build GeoPackages containing a variety of different data. Reading and writing of spatial ([vector](http://www.gdal.org/drv_geopackage.html) and [gridded](http://www.gdal.org/drv_geopackage_raster.html) data) is done via standard [GDAL](http://www.gdal.org/) utilities provided primarily by the {terra} package. Additional functions are provided to manipulate attributes and tabular data via [RSQLite](https://cran.r-project.org/web/packages/RSQLite/index.html).

<a href="https://raw.githubusercontent.com/brownag/gpkg/main/man/figures/gpkg_sticker_v1.png">
<img src = "https://raw.githubusercontent.com/brownag/gpkg/main/man/figures/gpkg_sticker_v1.png" alt = "gpkg hexsticker" title = "gpkg hexsticker: {gpkg} provides high-level wrapper functions to build GeoPackages containing a variety of different data." width = "35%" height = "35%" hspace="25" vspace="25" align="right"/></a>

## Installation

The package can be installed from GitHub with {remotes}

``` r
if (!requireNamespace("remotes")) install.packages("remotes")
remotes::install_github("brownag/gpkg")
```

## Background
### What is a GeoPackage?

[GeoPackage](https://www.geopackage.org/) is an open, standards-based, platform-independent, portable, self-describing, compact format for transferring geospatial information. The [GeoPackage Encoding Standard](https://www.ogc.org/standards/geopackage) describes a set of conventions for storing the following within an SQLite database:
  -  vector features
  -  tile matrix sets of imagery and raster maps at various scales
  -  attributes (non-spatial data)
  -  extensions

## Create a Geopackage

```{r}
library(gpkg)
library(terra)

dem <- system.file("extdata", "dem.tif", package = "gpkg")
stopifnot(nchar(dem) > 0)
gpkg_tmp <- tempfile(fileext = ".gpkg")

if (file.exists(gpkg_tmp))
  file.remove(gpkg_tmp)

# write a gpkg with two DEMs in it
gpkg_write(
  dem,
  destfile = gpkg_tmp,
  RASTER_TABLE = "DEM1",
  FIELD_NAME = "Elevation"
)
gpkg_write(
  dem,
  destfile = gpkg_tmp,
  append = TRUE,
  RASTER_TABLE = "DEM2",
  FIELD_NAME = "Elevation"
)
```

## Read a GeoPackage

```{r}
g <- geopackage(gpkg_tmp, connect = TRUE)
g
class(g)
```

## Insert Vector Layers

```{r}
# add bounding polygon vector layer
writeVector(
  terra::set.crs(terra::as.polygons(terra::ext(
    gpkg_tables(g)[['DEM1']])
  ), "OGC:CRS84"),
  filename = g$dsn,
  insert = TRUE
)

```

## Read a GeoPackage

```{r}
# enumerate tables
gpkg_list_tables(g)

# still connected
gpkg_is_connected(g)

# disconnect geopackage
gpkg_disconnect(g)
```
